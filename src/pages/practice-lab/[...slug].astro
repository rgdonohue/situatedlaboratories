---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AudioPlayer from '../../components/AudioPlayer.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { marked } from 'marked';

export async function getStaticPaths() {
  const practices = await getCollection('practices');
  return practices.map((practice) => ({
    params: { slug: practice.slug },
    props: { practice },
  }));
}

interface Props {
  practice: CollectionEntry<'practices'>;
}

const { practice } = Astro.props;
const { Content } = await practice.render();

// Render transcript markdown to HTML
const transcriptHtml = practice.data.transcript 
  ? marked.parse(practice.data.transcript)
  : '';
---

<BaseLayout 
  title={practice.data.title} 
  description={practice.data.description}
>
  <article class="container" style="padding: var(--space-2xl) 0; max-width: 700px;">
    <header style="margin-bottom: var(--space-xl);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm); flex-wrap: wrap; gap: var(--space-sm);">
        <time datetime={practice.data.pubDate.toISOString()} style="font-size: 0.9rem; color: var(--color-ink-secondary);">
          {practice.data.pubDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </time>
        <span style="font-size: 0.9rem; color: var(--color-teal); font-weight: 500;">
          {practice.data.duration}
        </span>
      </div>
      <h1>{practice.data.title}</h1>
      <p style="font-size: 1.1rem; color: var(--color-ink-secondary); margin-top: var(--space-sm);">
        {practice.data.description}
      </p>
    </header>
    
    {practice.data.audioUrl && (
      <div style="margin-bottom: var(--space-xl);">
        <AudioPlayer 
          src={practice.data.audioUrl}
          title={practice.data.title}
          transcript={practice.data.transcript}
          duration={practice.data.duration}
        />
      </div>
    )}
    
    {!practice.data.audioUrl && (
      <div style="margin-bottom: var(--space-xl); padding: var(--space-lg); background: var(--color-paper-dark); border-radius: 8px; border-left: 3px solid var(--color-forest);">
        <h2 style="font-size: 1.1rem; margin-bottom: var(--space-sm);">Practice Instructions</h2>
        <div class="transcript-content" set:html={transcriptHtml} />
      </div>
    )}
    
    <div class="content">
      <Content />
    </div>
    
    <footer style="margin-top: var(--space-2xl); padding-top: var(--space-xl); border-top: 1px solid var(--color-border);">
      <a href="/practice-lab">‚Üê Back to Practice Lab</a>
    </footer>
  </article>
</BaseLayout>

<style>
  .content {
    line-height: 1.8;
  }

  .content h2 {
    margin-top: var(--space-xl);
    margin-bottom: var(--space-md);
  }

  .content h3 {
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
  }

  .content p {
    margin-bottom: var(--space-md);
  }

  /* Transcript/instructions styling */
  .transcript-content {
    line-height: 1.8;
  }

  .transcript-content h1 {
    font-size: 1.25rem;
    margin-top: 0;
    margin-bottom: var(--space-md);
    font-weight: 600;
  }

  .transcript-content h2 {
    font-size: 1.1rem;
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
    font-weight: 600;
  }

  .transcript-content p {
    margin-bottom: var(--space-md);
  }

  .transcript-content strong {
    font-weight: 600;
    display: block;
    margin-top: var(--space-md);
    margin-bottom: var(--space-xs);
  }

  .transcript-content p:first-of-type strong {
    margin-top: 0;
  }

  .transcript-content ul,
  .transcript-content ol {
    margin-top: var(--space-xs);
    margin-bottom: var(--space-md);
    padding-left: var(--space-lg);
  }

  .transcript-content li {
    margin-bottom: var(--space-xs);
  }
</style>
